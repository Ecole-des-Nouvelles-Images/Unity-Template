name: Unity CI/CD Release Pipeline

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  UNITY_VERSION: "6000.0.49.f1"
  BUILD_WINDOWS: "true"
  BUILD_MAC: "false"
  BUILD_ANDROID: "false"
  FILE_PATTERNS: "*.unity *.prefab *.mat *.asset *.anim *.controller"
  ARCHIVE_NAME_WIN: "UnityBuild_Windows.zip"
  ARCHIVE_NAME_MAC: "UnityBuild_Mac.zip"
  ARCHIVE_NAME_ANDROID: "UnityBuild_Android.zip"
  DISCORD_MESSAGE: "Nouveau build Unity publiÃ© pour la version ${{ github.ref_name }} !"
  RELEASE_BODY: "Nouveau build Unity pour la version ${{ github.ref_name }}."
  RELEASE_NAME: "Unity Build"

jobs:
  setup:
    name: Setup Build Config
    runs-on: ubuntu-latest
    outputs:
      windows_enabled: ${{ steps.set_outputs.outputs.windows_enabled }}
      mac_enabled: ${{ steps.set_outputs.outputs.mac_enabled }}
      android_enabled: ${{ steps.set_outputs.outputs.android_enabled }}
    steps:
      - id: set_outputs
        run: |
          echo "windows_enabled=${{ env.BUILD_WINDOWS }}" >> $GITHUB_OUTPUT
          echo "mac_enabled=${{ env.BUILD_MAC }}" >> $GITHUB_OUTPUT
          echo "android_enabled=${{ env.BUILD_ANDROID }}" >> $GITHUB_OUTPUT

  check_conflicts:
    name: Check for Unity file conflicts
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v3
      - name: Detect merge conflict markers
        run: |
          echo "Checking for conflict markers in Unity files..."
          grep -r -E '<<<<<<<|=======|>>>>>>>' --include=${{ env.FILE_PATTERNS }} ./ || true
          CONFLICT_COUNT=$(grep -r -E '<<<<<<<|=======|>>>>>>>' --include=${{ env.FILE_PATTERNS }} ./ | wc -l)
          echo "Found $CONFLICT_COUNT conflict markers."
          if [ "$CONFLICT_COUNT" -gt 0 ]; then
            echo "::error file=CONFLICT,::Conflict markers found in Unity files! Please resolve before merging."
            exit 1
          fi

  activate_license:
    name: Activate Unity License
    needs: [setup, check_conflicts, activate_license]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Activate Unity License
        uses: game-ci/unity-activate@v2
        with:
          license: ${{ secrets.UNITY_LICENSE }}

  build_windows:
    if: needs.setup.outputs.windows_enabled == 'true'
    name: Build Windows
    needs: [setup, check_conflicts, activate_license]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Windows
        uses: game-ci/unity-builder@v2
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: StandaloneWindows64
      - run: |
          mkdir -p release
          zip -r release/${{ env.ARCHIVE_NAME_WIN }} build/StandaloneWindows64/

  build_mac:
    if: needs.setup.outputs.mac_enabled == 'true'
    name: Build Mac
    needs: [setup, check_conflicts, activate_license]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Mac
        uses: game-ci/unity-builder@v2
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: StandaloneOSX
      - run: |
          mkdir -p release
          zip -r release/${{ env.ARCHIVE_NAME_MAC }} build/StandaloneOSX/

  build_android:
    if: needs.setup.outputs.android_enabled == 'true'
    name: Build Android
    needs: [setup, check_conflicts, activate_license]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Android
        uses: game-ci/unity-builder@v2
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: Android
      - run: |
          mkdir -p release
          zip -r release/${{ env.ARCHIVE_NAME_ANDROID }} build/Android/

  release_build:
    name: Create or Update GitHub Release
    needs: [build_windows, build_mac, build_android]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ env.RELEASE_NAME }} ${{ github.ref_name }}
          body: ${{ env.RELEASE_BODY }}
          draft: false
          prerelease: false
          files: |
            release/${{ env.ARCHIVE_NAME_WIN }}
            release/${{ env.ARCHIVE_NAME_MAC }}
            release/${{ env.ARCHIVE_NAME_ANDROID }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify_team:
    name: Notify Team
    needs: release_build
    runs-on: ubuntu-latest
    steps:
      - name: Notify on Discord
        uses: Ilshidur/action-discord@master
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: ${{ env.DISCORD_MESSAGE }}
      - name: Notify on Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author
          author_name: GitHub Actions
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
